# Stage 2.2 Report

## Notes

* Compaction в репозитории производится "каждые 512 файла", поскольку полностью фоновый compaction я не сделал и он пока что сильно тормозит выполнение тестов. При проведении профилировки это значение будет намного ниже, чтобы во всей красе увидеть "великолепную" скорость работы. 
* В `ConcurrentTest` была добавлена аннотация `@RepeatedTest`, чтобы не перезапускать этот тест несколько раз.
* В `PersistenceTest.burnAndCompact()` были произведены изменения аналогичные лекции.
* В текущую версию кода по сравнению с последней лекцией была добавлена поддержка файлов с размером больше 2 Гб, сделана очередная попытка реализации конкурентного flush
* Время работы wrk было снижено с 6 минут до 3, а рейт увеличен до 20_000
* Время профилировки было снижено с 5 минут до 2

* Тест `hugeRecords` падает по непонятным причинам. Ключи, на которые он ругается, если их перевести в String, полностью совпадают. Как совпадают и соответствующие значения position, limit и capacity.  

## Нагрузочное тестирование `PUT`-запросами

```bash
wrk -c 16 -t 4 -d3m -R 20000 -L -s scripts/put.lua -L http://localhost:8080
```

### CPU

```bash
 ./profiler.sh -e cpu -d 120 -f putCpuConcurrentFlush2.html 255
```

### Alloc

```bash
 ./profiler.sh -e alloc -d 120 -f putAllocConcurrentFlush2.html 255
```

### Lock

```bash
 ./profiler.sh -e lock -d 120 -f putLockConcurrentFlush2.html 255
```

## Нагрузочное тестирование `GET`-запросами

```bash
wrk -c 16 -t 4 -d3m -R 20000 -L -s scripts/get.lua -L http://localhost:8080
```

### CPU

```bash
 ./profiler.sh -e cpu -d 120 -f getCpuConcurrentFlush2.html 255
```

### Alloc

```bash
 ./profiler.sh -e alloc -d 120 -f getAllocConcurrentFlush2.html 255
```

### Lock

```bash
 ./profiler.sh -e lock -d 120 -f getLockConcurrentFlush2.html 255
```

## Результаты

### PUT

```text 
 4 threads and 16 connections
  Thread calibration: mean lat.: 1.172ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.187ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.165ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.183ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.61ms   48.48ms   1.13s    99.39%
    Req/Sec     5.28k   810.93    28.56k    91.43%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.18ms
 75.000%    1.63ms
 90.000%    2.05ms
 99.000%    5.25ms
 99.900%  875.52ms
 99.990%    1.09s
 99.999%    1.12s
100.000%    1.13s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.025     0.000000            1         1.00
       0.427     0.100000       340725         1.11
       0.676     0.200000       680232         1.25
       0.867     0.300000      1020683         1.43
       1.027     0.400000      1361592         1.67
       1.178     0.500000      1700268         2.00
       1.254     0.550000      1870837         2.22
       1.334     0.600000      2041331         2.50
       1.421     0.650000      2209817         2.86
       1.519     0.700000      2379893         3.33
       1.629     0.750000      2550979         4.00
       1.687     0.775000      2635028         4.44
       1.748     0.800000      2719805         5.00
       1.813     0.825000      2805626         5.71
       1.882     0.850000      2890020         6.67
       1.958     0.875000      2974783         8.00
       2.000     0.887500      3017187         8.89
       2.046     0.900000      3059912        10.00
       2.097     0.912500      3102652        11.43
       2.155     0.925000      3145149        13.33
       2.223     0.937500      3188067        16.00
       2.261     0.943750      3208701        17.78
       2.305     0.950000      3230102        20.00
       2.355     0.956250      3251140        22.86
       2.415     0.962500      3272490        26.67
       2.489     0.968750      3293428        32.00
       2.535     0.971875      3303957        35.56
       2.589     0.975000      3314405        40.00
       2.659     0.978125      3325156        45.71
       2.751     0.981250      3335634        53.33
       2.901     0.984375      3346320        64.00
       3.033     0.985938      3351574        71.11
       3.335     0.987500      3356859        80.00
       4.263     0.989062      3362176        91.43
       6.111     0.990625      3367475       106.67
       9.767     0.992188      3372794       128.00
      14.615     0.992969      3375441       142.22
      38.175     0.993750      3378097       160.00
     157.439     0.994531      3380753       182.86
     283.647     0.995313      3383411       213.33
     407.039     0.996094      3386069       256.00
     471.295     0.996484      3387394       284.44
     536.063     0.996875      3388724       320.00
     598.527     0.997266      3390053       365.71
     660.479     0.997656      3391375       426.67
     724.479     0.998047      3392705       512.00
     756.223     0.998242      3393374       568.89
     787.967     0.998437      3394038       640.00
     819.199     0.998633      3394702       731.43
     849.407     0.998828      3395359       853.33
     879.615     0.999023      3396032      1024.00
     893.951     0.999121      3396360      1137.78
     909.311     0.999219      3396696      1280.00
     929.791     0.999316      3397020      1462.86
     954.879     0.999414      3397353      1706.67
     982.527     0.999512      3397684      2048.00
     997.887     0.999561      3397851      2275.56
    1012.735     0.999609      3398020      2560.00
    1026.559     0.999658      3398187      2925.71
    1038.847     0.999707      3398350      3413.33
    1049.599     0.999756      3398513      4096.00
    1053.695     0.999780      3398605      4551.11
    1059.839     0.999805      3398688      5120.00
    1065.983     0.999829      3398763      5851.43
    1073.151     0.999854      3398847      6826.67
    1081.343     0.999878      3398935      8192.00
    1085.439     0.999890      3398977      9102.22
    1089.535     0.999902      3399019     10240.00
    1092.607     0.999915      3399052     11702.86
    1096.703     0.999927      3399096     13653.33
    1100.799     0.999939      3399138     16384.00
    1102.847     0.999945      3399159     18204.44
    1104.895     0.999951      3399180     20480.00
    1106.943     0.999957      3399202     23405.71
    1108.991     0.999963      3399223     27306.67
    1111.039     0.999969      3399244     32768.00
    1112.063     0.999973      3399255     36408.89
    1113.087     0.999976      3399265     40960.00
    1114.111     0.999979      3399275     46811.43
    1115.135     0.999982      3399286     54613.33
    1116.159     0.999985      3399297     65536.00
    1116.159     0.999986      3399297     72817.78
    1117.183     0.999988      3399308     81920.00
    1117.183     0.999989      3399308     93622.86
    1118.207     0.999991      3399316    109226.67
    1119.231     0.999992      3399319    131072.00
    1119.231     0.999993      3399319    145635.56
    1120.255     0.999994      3399322    163840.00
    1121.279     0.999995      3399325    187245.71
    1122.303     0.999995      3399328    218453.33
    1123.327     0.999996      3399331    262144.00
    1123.327     0.999997      3399331    291271.11
    1124.351     0.999997      3399334    327680.00
    1124.351     0.999997      3399334    374491.43
    1125.375     0.999998      3399337    436906.67
    1125.375     0.999998      3399337    524288.00
    1125.375     0.999998      3399337    582542.22
    1125.375     0.999998      3399337    655360.00
    1126.399     0.999999      3399340    748982.86
    1126.399     0.999999      3399340    873813.33
    1126.399     0.999999      3399340   1048576.00
    1126.399     0.999999      3399340   1165084.44
    1126.399     0.999999      3399340   1310720.00
    1126.399     0.999999      3399340   1497965.71
    1127.423     0.999999      3399341   1747626.67
    1127.423     1.000000      3399341   2097152.00
    1127.423     1.000000      3399341   2330168.89
    1127.423     1.000000      3399341   2621440.00
    1127.423     1.000000      3399341   2995931.43
    1128.447     1.000000      3399342   3495253.33
    1128.447     1.000000      3399342          inf
#[Mean    =        4.610, StdDeviation   =       48.482]
#[Max     =     1127.424, Total count    =      3399342]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  3599573 requests in 3.00m, 230.00MB read
Requests/sec:  19999.94
Transfer/sec:      1.28MB

```

### Put после нескольких запусков

```text
 50.000%    1.16ms
 75.000%    1.63ms
 90.000%    2.13ms
 99.000%   59.52ms
 99.900%  215.04ms
 99.990%  284.93ms
 99.999%  330.49ms
100.000%  340.48ms
```

### GET

```text
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.184ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.186ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.209ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.206ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.32ms    1.36ms  70.66ms   97.92%
    Req/Sec     5.28k   587.95    22.22k    82.65%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.20ms
 75.000%    1.65ms
 90.000%    2.08ms
 99.000%    3.38ms
 99.900%   21.25ms
 99.990%   38.94ms
 99.999%   60.26ms
100.000%   70.72ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.034     0.000000            1         1.00
       0.436     0.100000       340398         1.11
       0.689     0.200000       681428         1.25
       0.881     0.300000      1021845         1.43
       1.040     0.400000      1361792         1.67
       1.196     0.500000      1700265         2.00
       1.277     0.550000      1871769         2.22
       1.360     0.600000      2040443         2.50
       1.449     0.650000      2210699         2.86
       1.546     0.700000      2381105         3.33
       1.651     0.750000      2549604         4.00
       1.709     0.775000      2634704         4.44
       1.772     0.800000      2720183         5.00
       1.839     0.825000      2804698         5.71
       1.912     0.850000      2889656         6.67
       1.992     0.875000      2974957         8.00
       2.036     0.887500      3017817         8.89
       2.083     0.900000      3060440        10.00
       2.133     0.912500      3102237        11.43
       2.191     0.925000      3145127        13.33
       2.257     0.937500      3187562        16.00
       2.295     0.943750      3209018        17.78
       2.337     0.950000      3230199        20.00
       2.385     0.956250      3251256        22.86
       2.441     0.962500      3272210        26.67
       2.509     0.968750      3293232        32.00
       2.551     0.971875      3303908        35.56
       2.601     0.975000      3314639        40.00
       2.661     0.978125      3325173        45.71
       2.739     0.981250      3335857        53.33
       2.849     0.984375      3346371        64.00
       2.925     0.985938      3351674        71.11
       3.031     0.987500      3357000        80.00
       3.199     0.989062      3362259        91.43
       3.569     0.990625      3367578       106.67
       4.407     0.992188      3372882       128.00
       5.099     0.992969      3375542       142.22
       5.971     0.993750      3378200       160.00
       7.043     0.994531      3380862       182.86
       8.335     0.995313      3383526       213.33
       9.911     0.996094      3386166       256.00
      10.823     0.996484      3387495       284.44
      11.919     0.996875      3388820       320.00
      13.071     0.997266      3390153       365.71
      14.407     0.997656      3391474       426.67
      15.863     0.998047      3392808       512.00
      16.735     0.998242      3393467       568.89
      17.711     0.998437      3394138       640.00
      18.815     0.998633      3394797       731.43
      20.047     0.998828      3395458       853.33
      21.423     0.999023      3396121      1024.00
      22.239     0.999121      3396455      1137.78
      23.135     0.999219      3396792      1280.00
      24.127     0.999316      3397117      1462.86
      25.295     0.999414      3397452      1706.67
      26.687     0.999512      3397780      2048.00
      27.455     0.999561      3397947      2275.56
      28.239     0.999609      3398114      2560.00
      29.295     0.999658      3398282      2925.71
      30.575     0.999707      3398444      3413.33
      32.015     0.999756      3398612      4096.00
      32.831     0.999780      3398694      4551.11
      33.695     0.999805      3398776      5120.00
      34.655     0.999829      3398861      5851.43
      35.807     0.999854      3398949      6826.67
      36.991     0.999878      3399025      8192.00
      37.951     0.999890      3399066      9102.22
      39.263     0.999902      3399108     10240.00
      40.703     0.999915      3399149     11702.86
      42.143     0.999927      3399192     13653.33
      43.551     0.999939      3399232     16384.00
      44.415     0.999945      3399253     18204.44
      45.471     0.999951      3399274     20480.00
      46.559     0.999957      3399295     23405.71
      47.775     0.999963      3399316     27306.67
      49.119     0.999969      3399336     32768.00
      49.823     0.999973      3399346     36408.89
      50.559     0.999976      3399357     40960.00
      51.135     0.999979      3399367     46811.43
      51.935     0.999982      3399377     54613.33
      53.439     0.999985      3399388     65536.00
      55.071     0.999986      3399393     72817.78
      58.111     0.999988      3399398     81920.00
      59.999     0.999989      3399403     93622.86
      61.119     0.999991      3399408    109226.67
      61.951     0.999992      3399414    131072.00
      62.463     0.999993      3399416    145635.56
      63.199     0.999994      3399419    163840.00
      63.487     0.999995      3399421    187245.71
      64.447     0.999995      3399424    218453.33
      64.895     0.999996      3399427    262144.00
      65.087     0.999997      3399428    291271.11
      65.439     0.999997      3399429    327680.00
      65.471     0.999997      3399430    374491.43
      66.751     0.999998      3399432    436906.67
      67.391     0.999998      3399433    524288.00
      68.031     0.999998      3399434    582542.22
      68.031     0.999998      3399434    655360.00
      68.543     0.999999      3399435    748982.86
      68.991     0.999999      3399436    873813.33
      68.991     0.999999      3399436   1048576.00
      69.503     0.999999      3399437   1165084.44
      69.503     0.999999      3399437   1310720.00
      69.503     0.999999      3399437   1497965.71
      70.143     0.999999      3399438   1747626.67
      70.143     1.000000      3399438   2097152.00
      70.143     1.000000      3399438   2330168.89
      70.143     1.000000      3399438   2621440.00
      70.143     1.000000      3399438   2995931.43
      70.719     1.000000      3399439   3495253.33
      70.719     1.000000      3399439          inf
#[Mean    =        1.322, StdDeviation   =        1.362]
#[Max     =       70.656, Total count    =      3399439]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  3599678 requests in 3.00m, 246.10MB read
  Non-2xx or 3xx responses: 1567512
Requests/sec:  19999.37
Transfer/sec:      1.37MB


```

## Профилировщик

|     | CPU | Alloc | Lock |
| --- | --- | ----- | ---- |
| GET | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/getCpuConcurrentFlush2.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/getAllocConcurrentFlush2.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/getLockConcurrentFlush2.html) |   
| PUT | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/putCpuConcurrentFlush2.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/putAllocConcurrentFlush2.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/putLockConcurrentFlush2.html) |

## Выводы

* По профилю cpu при put запросах хорошо видно, что очень сильно начали выделяться два горба compaction. Там происходит очень неоптимизированная запись в файл. Необходимо буферизовать ключи перед записью.
* По этому же профилю видно небольшой горб FileChannelImpl.position. Возможно, у нас нет необходимости каждый раз вычислять это значение с помощью системных вызовов - мы же пишем в файл из одного места и знаем размер того, что пишем.
* Flush вообще потерялся на фоне compaction, потому что почти все время профилировки стоял в блокировке, ожидая окончание compaction.

* При просмотре профиля cpu при get запросах в глаза бросается свежеиспеченный буфер, написанный для поддержки файлов >2 Гб. Практически все вычисления в SSTable.offset переходят в вычисления LongMappedByteBuffer.mismatch и LongMappedByteBuffer.getInt. Стоит обратить внимание на этот класс.

* Кроме того, по всем cpu профилям можно сказать, что сборщик мусора активно что-то собирает, внося вклад в задержку. Нужно что-то сделать. Например, попробовать другой сборщик мусора. В частности, Алексей Шипелёв очень вкусно описывал Shenandoah.
