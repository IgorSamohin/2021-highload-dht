# Stage 1 Report

## Tips

* Нагрузка давалась в одно подключение и одно соединение с R = 1000 запросов в секунду на протяжении 11 минут для одного типа запросов.

* Профилировка при `GET` и при `PUT` запросах производилась на протяжении 5 минут для cpu и для alloc

* Выводы по Flame Graph делались на основе тех пунктов, которые шли после вызова `.../igorsamokhin/ServiceImpl.entity`, поскольку все остальные вызовы относятся к работе `one-nio`.  

## Нагрузочное тестирование `PUT`-запросами

```bash
wrk -c 1 -t 1 -d11m -R 1000 -L -s scripts/put.lua -L http://localhost:8080
```

#### Результаты

```text
 1 threads and 1 connections
  Thread calibration: mean lat.: 1.639ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.86ms    8.05ms 200.19ms   99.37%
    Req/Sec   773.92    518.14    14.89k    72.25%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.30ms
 75.000%    1.67ms
 90.000%    2.05ms
 99.000%    2.47ms
 99.900%  147.97ms
 99.990%  174.59ms
 99.999%  196.10ms
100.000%  200.32ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.085     0.000000            1         1.00
       0.584     0.100000        47846         1.11
       0.832     0.200000        95883         1.25
       1.014     0.300000       143707         1.43
       1.158     0.400000       191539         1.67
       1.297     0.500000       239404         2.00
       1.365     0.550000       263161         2.22
       1.434     0.600000       287040         2.50
       1.507     0.650000       310950         2.86
       1.586     0.700000       335046         3.33
       1.668     0.750000       358986         4.00
       1.712     0.775000       370884         4.44
       1.763     0.800000       382694         5.00
       1.823     0.825000       394709         5.71
       1.889     0.850000       406620         6.67
       1.966     0.875000       418646         8.00
       2.007     0.887500       424595         8.89
       2.049     0.900000       430728        10.00
       2.089     0.912500       436652        11.43
       2.133     0.925000       442591        13.33
       2.177     0.937500       448584        16.00
       2.201     0.943750       451558        17.78
       2.225     0.950000       454567        20.00
       2.251     0.956250       457492        22.86
       2.279     0.962500       460403        26.67
       2.311     0.968750       463429        32.00
       2.329     0.971875       464936        35.56
       2.347     0.975000       466376        40.00
       2.367     0.978125       467954        45.71
       2.387     0.981250       469376        53.33
       2.413     0.984375       470888        64.00
       2.425     0.985938       471608        71.11
       2.441     0.987500       472382        80.00
       2.459     0.989062       473100        91.43
       2.485     0.990625       473829       106.67
       2.551     0.992188       474577       128.00
       3.317     0.992969       474943       142.22
      10.215     0.993750       475317       160.00
      26.015     0.994531       475691       182.86
      47.071     0.995313       476065       213.33
      68.415     0.996094       476438       256.00
      79.359     0.996484       476626       284.44
      90.175     0.996875       476812       320.00
     100.735     0.997266       476999       365.71
     111.679     0.997656       477187       426.67
     122.431     0.998047       477372       512.00
     127.551     0.998242       477466       568.89
     132.863     0.998437       477560       640.00
     138.239     0.998633       477655       731.43
     143.359     0.998828       477746       853.33
     148.607     0.999023       477840      1024.00
     151.295     0.999121       477888      1137.78
     153.855     0.999219       477933      1280.00
     156.543     0.999316       477982      1462.86
     158.975     0.999414       478027      1706.67
     161.791     0.999512       478074      2048.00
     163.071     0.999561       478096      2275.56
     164.607     0.999609       478122      2560.00
     165.759     0.999658       478143      2925.71
     167.295     0.999707       478168      3413.33
     168.959     0.999756       478192      4096.00
     169.471     0.999780       478201      4551.11
     170.239     0.999805       478214      5120.00
     171.135     0.999829       478225      5851.43
     172.415     0.999854       478236      6826.67
     173.439     0.999878       478249      8192.00
     174.207     0.999890       478256      9102.22
     175.103     0.999902       478260     10240.00
     176.511     0.999915       478266     11702.86
     178.303     0.999927       478272     13653.33
     180.095     0.999939       478278     16384.00
     180.991     0.999945       478280     18204.44
     181.887     0.999951       478284     20480.00
     182.783     0.999957       478286     23405.71
     185.471     0.999963       478289     27306.67
     188.159     0.999969       478292     32768.00
     189.055     0.999973       478293     36408.89
     190.719     0.999976       478295     40960.00
     191.615     0.999979       478296     46811.43
     193.407     0.999982       478298     54613.33
     194.303     0.999985       478299     65536.00
     195.199     0.999986       478300     72817.78
     196.095     0.999988       478301     81920.00
     196.095     0.999989       478301     93622.86
     196.863     0.999991       478302    109226.67
     197.759     0.999992       478303    131072.00
     197.759     0.999993       478303    145635.56
     198.655     0.999994       478304    163840.00
     198.655     0.999995       478304    187245.71
     198.655     0.999995       478304    218453.33
     199.551     0.999996       478305    262144.00
     199.551     0.999997       478305    291271.11
     199.551     0.999997       478305    327680.00
     199.551     0.999997       478305    374491.43
     199.551     0.999998       478305    436906.67
     200.319     0.999998       478306    524288.00
     200.319     1.000000       478306          inf
#[Mean    =        1.860, StdDeviation   =        8.046]
#[Max     =      200.192, Total count    =       478306]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  488310 requests in 11.00m, 31.20MB read
  Socket errors: connect 0, read 0, write 0, timeout 85
Requests/sec:    739.82
Transfer/sec:     48.41KB
```


### Cpu

```bash
./profiler.sh -e cpu -d 300 -f putCpu.html 175
```

#### Результаты

[img/putCpu.png](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/putCpu.html)

### Alloc

```bash
./profiler.sh -e alloc -d 300 -f putAlloc.html 175
```

#### Результаты

[putAlloc.png](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/putAlloc.html)

## Нагрузочное тестирование `GET`-запросами

```bash
wrk -c 1 -t 1 -d11m -R 1000 -L -s scripts/get.lua -L http://localhost:8080
```

#### Результаты

```text
  1 threads and 1 connections
  Thread calibration: mean lat.: 24.614ms, rate sampling interval: 215ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    26.50ms   49.61ms 327.68ms   83.85%
    Req/Sec     1.00k   376.30     2.24k    68.69%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.52ms
 75.000%   19.97ms
 90.000%  115.26ms
 99.000%  184.19ms
 99.900%  235.26ms
 99.990%  284.93ms
 99.999%  322.56ms
100.000%  327.93ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.073     0.000000            1         1.00
       0.672     0.100000        65163         1.11
       0.949     0.200000       130176         1.25
       1.152     0.300000       195334         1.43
       1.331     0.400000       260139         1.67
       1.524     0.500000       325012         2.00
       1.640     0.550000       357652         2.22
       1.782     0.600000       390126         2.50
       1.978     0.650000       422550         2.86
       2.239     0.700000       455091         3.33
      19.967     0.750000       487503         4.00
      35.839     0.775000       503761         4.44
      51.711     0.800000       519999         5.00
      67.583     0.825000       536254         5.71
      83.455     0.850000       552515         6.67
      99.263     0.875000       568752         8.00
     107.199     0.887500       576886         8.89
     115.263     0.900000       585037        10.00
     123.391     0.912500       593162        11.43
     131.583     0.925000       601298        13.33
     139.775     0.937500       609379        16.00
     143.999     0.943750       613554        17.78
     148.095     0.950000       617532        20.00
     152.191     0.956250       621568        22.86
     156.415     0.962500       625678        26.67
     160.639     0.968750       629726        32.00
     162.815     0.971875       631767        35.56
     165.119     0.975000       633846        40.00
     167.423     0.978125       635787        45.71
     170.239     0.981250       637877        53.33
     173.567     0.984375       639901        64.00
     175.743     0.985938       640881        71.11
     178.431     0.987500       641897        80.00
     181.759     0.989062       642909        91.43
     185.855     0.990625       643905       106.67
     190.591     0.992188       644917       128.00
     193.279     0.992969       645442       142.22
     195.967     0.993750       645939       160.00
     198.911     0.994531       646454       182.86
     201.983     0.995313       646945       213.33
     205.695     0.996094       647453       256.00
     207.871     0.996484       647714       284.44
     210.303     0.996875       647969       320.00
     212.991     0.997266       648221       365.71
     216.191     0.997656       648471       426.67
     219.903     0.998047       648722       512.00
     222.335     0.998242       648857       568.89
     224.895     0.998437       648976       640.00
     227.967     0.998633       649105       731.43
     231.551     0.998828       649232       853.33
     235.903     0.999023       649363      1024.00
     238.335     0.999121       649422      1137.78
     241.023     0.999219       649484      1280.00
     243.967     0.999316       649547      1462.86
     247.935     0.999414       649613      1706.67
     252.159     0.999512       649675      2048.00
     254.463     0.999561       649706      2275.56
     256.767     0.999609       649739      2560.00
     259.327     0.999658       649771      2925.71
     262.655     0.999707       649802      3413.33
     267.007     0.999756       649833      4096.00
     269.823     0.999780       649851      4551.11
     271.871     0.999805       649865      5120.00
     274.687     0.999829       649880      5851.43
     278.015     0.999854       649896      6826.67
     281.855     0.999878       649913      8192.00
     283.647     0.999890       649921      9102.22
     285.439     0.999902       649929     10240.00
     287.231     0.999915       649937     11702.86
     289.535     0.999927       649945     13653.33
     292.607     0.999939       649952     16384.00
     295.935     0.999945       649956     18204.44
     299.775     0.999951       649960     20480.00
     303.359     0.999957       649964     23405.71
     306.943     0.999963       649968     27306.67
     310.527     0.999969       649972     32768.00
     312.319     0.999973       649974     36408.89
     314.367     0.999976       649976     40960.00
     316.159     0.999979       649978     46811.43
     317.951     0.999982       649980     54613.33
     319.743     0.999985       649982     65536.00
     320.767     0.999986       649983     72817.78
     321.535     0.999988       649984     81920.00
     322.559     0.999989       649985     93622.86
     323.327     0.999991       649986    109226.67
     324.351     0.999992       649987    131072.00
     324.351     0.999993       649987    145635.56
     325.119     0.999994       649988    163840.00
     325.119     0.999995       649988    187245.71
     326.143     0.999995       649989    218453.33
     326.143     0.999996       649989    262144.00
     326.143     0.999997       649989    291271.11
     326.911     0.999997       649990    327680.00
     326.911     0.999997       649990    374491.43
     326.911     0.999998       649990    436906.67
     326.911     0.999998       649990    524288.00
     326.911     0.999998       649990    582542.22
     327.935     0.999998       649991    655360.00
     327.935     1.000000       649991          inf
#[Mean    =       26.503, StdDeviation   =       49.612]
#[Max     =      327.680, Total count    =       649991]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  659996 requests in 11.00m, 45.64MB read
  Non-2xx or 3xx responses: 171686
Requests/sec:   1000.00
Transfer/sec:     70.82KB


```

### Cpu

```bash
./profiler.sh -e cpu -d 300 -f getCpu.html 175
```

#### Результаты

[getCpu](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/getCpu.html)

### Alloc

```bash
./profiler.sh -e alloc -d 300 -f getAlloc.html 175
```

#### Результаты

[getAlloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/getAlloc.html)

## Выводы

* По процентильным спектрам, полученным из `wrk2` видно, что сервер немного лучше справляется с обработкой `GET` запросов, чем `PUT`, если рассматривать выполненное количество запросов, однако максимальная задержка больше при `GET` запросах. Причиной этому может быть усиленная работа сборщика мусора. Что же он там собирает такого?)
* Выделений памяти было зафиксировано в почти 4 раза больше при `GET` запросах. Параллельно с этим процессор проводит много времени в методе `range`. Кроме того, он занимает почти 24% выделений памяти, в то время как его "оппонент" - метод `upsert` - 6%. И скорее всего все этими выделениями и занимается сборщик. 
* Если продолжать рассматривать выделения памяти в методе `range`, то можно заметить, что почти все выделения памяти относятся к работе PriorityQueue, которая используется в итераторах. С этим явно необходимо что-то делать! Однако пока не понятно, что именно. 
* Настала пора вспомнить про отчеты по `cpu`. По ним видно, что процессор тратит много времени на работу внутри ConcurrentSkipListMap в обоих случаях. При вставке скорее всего время тратится на обеспечивание необходимой потокобезопасности, так что здесь все вроде хорошо. При чтении процессор тратит много времени на построении итератора по всей ConcurrentSkipListMap. Интересно, можем ли мы как-то этого избежать? Например, не строя итератор, если нужен только один конкретный ключ. Это могло бы также решить проблему частых выделений памяти в PriorityQueue. 

---

* После занятия были произведены все оптимизации записи в файл по образу и подобию лекции. А также заново проведена профилировка, поскольку предыдущая была выполнена неправильно.
* При повторной профилировке в wrk rate был поднят до R=5000, а время снижено до 6 минут
* Дальнейшие рассуждения будут отталкиваться от новых результатов

```bash
wrk -c 1 -t 1 -d6m -R 5000 -L -s scripts/put.lua -L http://localhost:8080
```

```text
   1 threads and 1 connections
  Thread calibration: mean lat.: 50.037ms, rate sampling interval: 159ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    18.98ms   73.64ms 858.11ms   97.05%
    Req/Sec     5.02k     1.07k   14.08k    92.64%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.25ms
 75.000%   11.81ms
 90.000%   34.14ms
 99.000%  484.61ms
 99.900%  765.44ms
 99.990%  850.94ms
 99.999%  858.11ms
100.000%  858.62ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.059     0.000000            1         1.00
       0.378     0.100000       175412         1.11
       0.616     0.200000       350550         1.25
       0.842     0.300000       525701         1.43
       1.054     0.400000       700334         1.67
       1.252     0.500000       875325         2.00
       1.402     0.550000       962811         2.22
       1.787     0.600000      1050099         2.50
       2.873     0.650000      1137458         2.86
       6.619     0.700000      1224984         3.33
      11.807     0.750000      1312498         4.00
      14.663     0.775000      1356269         4.44
      17.455     0.800000      1400110         5.00
      20.751     0.825000      1443799         5.71
      24.415     0.850000      1487502         6.67
      28.719     0.875000      1531260         8.00
      30.959     0.887500      1553109         8.89
      34.143     0.900000      1574979        10.00
      37.695     0.912500      1596964        11.43
      41.503     0.925000      1618744        13.33
      45.407     0.937500      1640617        16.00
      48.319     0.943750      1651608        17.78
      51.615     0.950000      1662464        20.00
      56.383     0.956250      1673378        22.86
      63.199     0.962500      1684318        26.67
      84.543     0.968750      1695259        32.00
      98.431     0.971875      1700772        35.56
     111.999     0.975000      1706188        40.00
     167.423     0.978125      1711662        45.71
     251.135     0.981250      1717127        53.33
     335.615     0.984375      1722607        64.00
     377.087     0.985938      1725333        71.11
     418.815     0.987500      1728065        80.00
     459.007     0.989062      1730796        91.43
     501.503     0.990625      1733538       106.67
     544.255     0.992188      1736270       128.00
     565.247     0.992969      1737644       142.22
     586.239     0.993750      1739007       160.00
     607.743     0.994531      1740367       182.86
     628.735     0.995313      1741757       213.33
     649.215     0.996094      1743105       256.00
     659.967     0.996484      1743805       284.44
     671.743     0.996875      1744469       320.00
     683.519     0.997266      1745154       365.71
     698.879     0.997656      1745835       426.67
     715.775     0.998047      1746525       512.00
     722.431     0.998242      1746876       568.89
     731.647     0.998437      1747209       640.00
     743.935     0.998633      1747544       731.43
     751.103     0.998828      1747900       853.33
     767.999     0.999023      1748229      1024.00
     778.239     0.999121      1748402      1137.78
     786.943     0.999219      1748567      1280.00
     793.599     0.999316      1748741      1462.86
     805.375     0.999414      1748912      1706.67
     821.247     0.999512      1749083      2048.00
     828.927     0.999561      1749170      2275.56
     833.023     0.999609      1749259      2560.00
     838.143     0.999658      1749348      2925.71
     841.215     0.999707      1749436      3413.33
     843.263     0.999756      1749514      4096.00
     844.799     0.999780      1749568      4551.11
     845.823     0.999805      1749605      5120.00
     846.847     0.999829      1749637      5851.43
     848.895     0.999854      1749690      6826.67
     849.919     0.999878      1749724      8192.00
     850.943     0.999890      1749759      9102.22
     851.455     0.999902      1749773     10240.00
     852.479     0.999915      1749795     11702.86
     852.991     0.999927      1749808     13653.33
     854.015     0.999939      1749834     16384.00
     854.527     0.999945      1749847     18204.44
     855.039     0.999951      1749858     20480.00
     855.551     0.999957      1749869     23405.71
     856.063     0.999963      1749874     27306.67
     857.087     0.999969      1749889     32768.00
     857.087     0.999973      1749889     36408.89
     857.599     0.999976      1749900     40960.00
     857.599     0.999979      1749900     46811.43
     858.111     0.999982      1749932     54613.33
     858.111     0.999985      1749932     65536.00
     858.111     0.999986      1749932     72817.78
     858.111     0.999988      1749932     81920.00
     858.111     0.999989      1749932     93622.86
     858.111     0.999991      1749932    109226.67
     858.111     0.999992      1749932    131072.00
     858.111     0.999993      1749932    145635.56
     858.111     0.999994      1749932    163840.00
     858.111     0.999995      1749932    187245.71
     858.111     0.999995      1749932    218453.33
     858.111     0.999996      1749932    262144.00
     858.111     0.999997      1749932    291271.11
     858.111     0.999997      1749932    327680.00
     858.111     0.999997      1749932    374491.43
     858.111     0.999998      1749932    436906.67
     858.111     0.999998      1749932    524288.00
     858.111     0.999998      1749932    582542.22
     858.111     0.999998      1749932    655360.00
     858.111     0.999999      1749932    748982.86
     858.111     0.999999      1749932    873813.33
     858.623     0.999999      1749934   1048576.00
     858.623     1.000000      1749934          inf
#[Mean    =       18.977, StdDeviation   =       73.637]
#[Max     =      858.112, Total count    =      1749934]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1799954 requests in 6.00m, 115.01MB read
Requests/sec:   4999.95
Transfer/sec:    327.15KB

```


### Cpu

```bash
./profiler.sh -e cpu -d 300 -f newPutCpu.html 2657
```

[newPutCpu](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newPutCpu.html)

### Alloc

```bash
./profiler.sh -e alloc -d 300 -f newPutAlloc.html 2657
```

[newPutAlloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newPutAlloc.html)

## Нагрузочное тестирование `GET`-запросами

```bash
wrk -c 1 -t 1 -d6m -R 5000 -L -s scripts/get.lua -L http://localhost:8080
```

```text
    1 threads and 1 connections
  Thread calibration: mean lat.: 13.712ms, rate sampling interval: 104ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     8.08ms   16.62ms 188.29ms   89.23%
    Req/Sec     5.03k   736.11    10.73k    79.99%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.24ms
 75.000%    6.74ms
 90.000%   26.58ms
 99.000%   77.38ms
 99.900%  154.49ms
 99.990%  182.65ms
 99.999%  188.29ms
100.000%  188.41ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.080     0.000000            1         1.00
       0.386     0.100000       175129         1.11
       0.619     0.200000       350088         1.25
       0.838     0.300000       525810         1.43
       1.046     0.400000       700353         1.67
       1.238     0.500000       875650         2.00
       1.354     0.550000       963244         2.22
       1.574     0.600000      1050246         2.50
       2.067     0.650000      1137809         2.86
       3.447     0.700000      1225232         3.33
       6.735     0.750000      1312694         4.00
       8.719     0.775000      1356453         4.44
      10.927     0.800000      1400272         5.00
      13.551     0.825000      1443963         5.71
      16.751     0.850000      1487838         6.67
      21.039     0.875000      1531524         8.00
      23.631     0.887500      1553363         8.89
      26.575     0.900000      1575268        10.00
      29.599     0.912500      1597203        11.43
      33.119     0.925000      1619108        13.33
      36.703     0.937500      1641018        16.00
      38.943     0.943750      1651881        17.78
      41.791     0.950000      1662819        20.00
      45.023     0.956250      1673759        22.86
      48.703     0.962500      1684639        26.67
      52.479     0.968750      1695593        32.00
      54.431     0.971875      1701058        35.56
      56.991     0.975000      1706527        40.00
      60.127     0.978125      1712019        45.71
      63.807     0.981250      1717474        53.33
      68.223     0.984375      1722937        64.00
      70.591     0.985938      1725706        71.11
      73.023     0.987500      1728456        80.00
      75.647     0.989062      1731124        91.43
      78.527     0.990625      1733877       106.67
      82.495     0.992188      1736599       128.00
      85.439     0.992969      1737969       142.22
      88.703     0.993750      1739346       160.00
      91.839     0.994531      1740708       182.86
      95.807     0.995313      1742074       213.33
     102.335     0.996094      1743435       256.00
     104.703     0.996484      1744119       284.44
     110.847     0.996875      1744793       320.00
     118.911     0.997266      1745475       365.71
     126.399     0.997656      1746158       426.67
     135.167     0.998047      1746856       512.00
     139.263     0.998242      1747184       568.89
     143.359     0.998437      1747528       640.00
     147.967     0.998633      1747872       731.43
     150.783     0.998828      1748254       853.33
     155.647     0.999023      1748551      1024.00
     158.207     0.999121      1748733      1137.78
     160.767     0.999219      1748893      1280.00
     163.327     0.999316      1749065      1462.86
     164.607     0.999414      1749245      1706.67
     165.503     0.999512      1749405      2048.00
     166.143     0.999561      1749520      2275.56
     166.655     0.999609      1749583      2560.00
     167.167     0.999658      1749680      2925.71
     167.551     0.999707      1749746      3413.33
     169.215     0.999756      1749831      4096.00
     171.519     0.999780      1749874      4551.11
     173.695     0.999805      1749917      5120.00
     175.999     0.999829      1749960      5851.43
     178.303     0.999854      1750004      6826.67
     180.607     0.999878      1750045      8192.00
     181.759     0.999890      1750067      9102.22
     182.911     0.999902      1750090     10240.00
     183.935     0.999915      1750109     11702.86
     185.087     0.999927      1750131     13653.33
     186.239     0.999939      1750154     16384.00
     186.623     0.999945      1750163     18204.44
     187.007     0.999951      1750174     20480.00
     187.263     0.999957      1750185     23405.71
     187.519     0.999963      1750197     27306.67
     187.775     0.999969      1750208     32768.00
     187.903     0.999973      1750216     36408.89
     187.903     0.999976      1750216     40960.00
     188.159     0.999979      1750229     46811.43
     188.159     0.999982      1750229     54613.33
     188.287     0.999985      1750244     65536.00
     188.287     0.999986      1750244     72817.78
     188.287     0.999988      1750244     81920.00
     188.287     0.999989      1750244     93622.86
     188.287     0.999991      1750244    109226.67
     188.415     0.999992      1750258    131072.00
     188.415     1.000000      1750258          inf
#[Mean    =        8.079, StdDeviation   =       16.618]
#[Max     =      188.288, Total count    =      1750258]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1799973 requests in 6.00m, 127.67MB read
  Non-2xx or 3xx responses: 19
Requests/sec:   4999.99
Transfer/sec:    363.17KB

```

### Cpu

```bash
./profiler.sh -e cpu -d 300 -f newGetCpu.html 2657
```

[newGetCpu](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newGetCpu.html)

### Alloc

```bash
./profiler.sh -e alloc -d 300 -f newGetAlloc.html 2657
```

[newGetAlloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newGetAlloc.html)

* на [newPutCpu](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newPutCpu.html) между вызовами entity и put есть небольшая полочка. Предположение - ненужная работа switch. Если проаннотировать все методы (get, put ...), то one-nio будет в состоянии довольно быстро выбирать обработчик запросов без помощи switch.
* на [newPutAlloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newPutAlloc.html) после вызова upsert есть выделения памяти из метода getKey, необходимые только для подсчета размера буфера 
* на [newGetAlloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newGetAlloc.html) после вызова LsmDAO.range и следующего вызова LsmDAO.merge видны аллокации в методе MergingIterator.clearQueue. Скорее всего они вызваны циклом while, который на каждой итерации выделяет память для проверки условия.
* Все они используются для того, чтобы получить сравнить два буфера или вычислить размер. Так как дальше полученные значения не используются, то можно эти действия проводить внутри Record. Это уберет лишние аллокации и время cpu, потраченное на выделение памяти.

### Выводы оптимизации

[Проверка put - cpu](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newPutCpuCheck.html)
[Проверка put - alloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newPutAllocCheck.html)
[Проверка get - cpu](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newGetCpuCheck.html)
[Проверка get - alloc](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage1/newGetAllocCheck.html)

Задержка при `PUT`

```
50.000%    1.12ms
75.000%    2.40ms
90.000%   15.18ms
99.000%  611.84ms
99.900%  926.72ms
99.990%    1.02s
99.999%    1.03s
100.000%    1.03s
```

Задержка при `GET`

```
50.000%    1.15ms
75.000%    4.36ms
90.000%   31.14ms
99.000%   89.54ms
99.900%  171.77ms
99.990%  238.08ms
99.999%  239.36ms
100.000%  239.49ms
```

* После повторной профилировки наличие признаков "полочки" замечено не было (если бы дело было не в switch, то полочка по идее должна была остаться до вызова put, а ее нет)
* Количество вызовов getKey из метода upsert практически не изменилось, что может говорить о том, что jvm мог произвести оптимизацию в предыдущем варианте и избавился сам от лишних аллокаций.
* По отчету работы cpu при get запросах видно, что процессорное время на аллокации вообще не тратится. И граф аллокаций полностью подтверждает, что удалось спилить горб, который ранее занимал ~7.5% аллокаций Это успех, товарищи!
* После сравнения задержек до и после оптимизации значительного результата замечено не было, но это может быть связано с тем, что прирост производительности очень мал и перекрывается погрешностями.