# Stage 2 Report

## Нагрузочное тестирование `PUT`-запросами

```bash
wrk -c 16 -t 4 -d6m -R 10000 -L -s scripts/put.lua -L http://localhost:8080
```

### CPU

```bash
 ./profiler.sh -e cpu -d 300 -f putCpuConcurrentFlush.html 194
```

### Alloc

```bash
 ./profiler.sh -e alloc -d 300 -f putAllocConcurrentFlush.html 194
```

### Lock

```bash
 ./profiler.sh -e lock -d 300 -f putLockConcurrentFlush.html 194
```

## Нагрузочное тестирование `GET`-запросами

```bash
wrk -c 16 -t 4 -d6m -R 10000 -L -s scripts/get.lua -L http://localhost:8080
```

### CPU

```bash
 ./profiler.sh -e cpu -d 300 -f getCpuConcurrentFlush.html 194
```

### Alloc

```bash
 ./profiler.sh -e alloc -d 300 -f getAllocConcurrentFlush.html 194
```

### Lock

```bash
 ./profiler.sh -e lock -d 300 -f getLockConcurrentFlush.html 194
```

## Результаты

### PUT

```text 
Thread Stats   Avg    Stdev    Max   +/- Stdev  
Latency     1.10ms  546.44us  21.26ms   70.22% 
Req/Sec     2.64k   204.00     7.33k    74.44%                                               
Latency Distribution                                                                     
(HdrHistogram - Recorded Latency)                                                        
            50.000%    1.06ms                                   
            75.000%    1.45ms                                               
            90.000%    1.78ms                                          
            99.000%    2.26ms                                          
            99.900%    4.45ms                                          
            99.990%   12.53ms                                          
            99.999%   17.65ms                                          
            100.000%   21.28ms                                         
                                                                       
Detailed Percentile spectrum:                                           
Value   Percentile   TotalCount 1/(1-Percentile                     
                                                                        
 0.031     0.000000            1         1.00                                                                                                
 0.469     0.100000       350922         1.11                           
 0.635     0.200000       702241         1.25                                           
 0.773     0.300000      1050557         1.43                                           
 0.914     0.400000      1401632         1.67                                           
 1.060     0.500000      1749924         2.00                                           
 1.134     0.550000      1926317         2.22                                           
 1.208     0.600000      2101350         2.50                                           
 1.283     0.650000      2276505         2.86                                           
 1.361     0.700000      2451793         3.33                                           
 1.445     0.750000      2625294         4.00                                           
 1.491     0.775000      2713636         4.44                                           
 1.540     0.800000      2801014         5.00                                           
 1.592     0.825000      2887711         5.71                                           
 1.649     0.850000      2974871         6.67                                           
 1.711     0.875000      3062827         8.00                                           
 1.745     0.887500      3107062         8.89                                           
 1.780     0.900000      3150360        10.00                                           
 1.818     0.912500      3194405        11.43                                           
 1.858     0.925000      3237294        13.33                                           
 1.903     0.937500      3281292        16.00                                           
 1.928     0.943750      3303519        17.78                                           
 1.954     0.950000      3325202        20.00                                           
 1.983     0.956250      3347030        22.86                                           
 2.015     0.962500      3368859        26.67                                           
 2.051     0.968750      3390853        32.00                                           
 2.071     0.971875      3401417        35.56                                           
 2.093     0.975000      3412148        40.00                                           
 2.119     0.978125      3423421        45.71                                           
 2.147     0.981250      3434348        53.33                                           
 2.179     0.984375      3445268        64.00                                           
 2.197     0.985938      3450624        71.11                                           
 2.219     0.987500      3456309        80.00                                           
 2.241     0.989062      3461594        91.43                                           
 2.267     0.990625      3466886       106.67                                           
 2.301     0.992188      3472499       128.00                                           
 2.319     0.992969      3475089       142.22                                           
 2.341     0.993750      3477746       160.00                                           
 2.369     0.994531      3480634       182.86                                           
 2.399     0.995313      3483247       213.33                                           
 2.441     0.996094      3486010       256.00                                           
 2.467     0.996484      3487353       284.44                                           
 2.501     0.996875      3488727       320.00                                           
 2.545     0.997266      3490041       365.71                                           
 2.609     0.997656      3491395       426.67                                           
 2.719     0.998047      3492766       512.00                                           
 2.833     0.998242      3493446       568.89                                           
 3.047     0.998437      3494127       640.00                                           
 3.453     0.998633      3494810       731.43                                           
 3.925     0.998828      3495494       853.33                                           
 4.531     0.999023      3496178      1024.00                                           
 4.879     0.999121      3496523      1137.78                                           
 5.227     0.999219      3496864      1280.00                                           
 5.663     0.999316      3497203      1462.86                                           
 6.187     0.999414      3497545      1706.67                                           
 6.791     0.999512      3497887      2048.00                                           
 7.167     0.999561      3498058      2275.56                                           
 7.579     0.999609      3498227      2560.00                                           
 8.027     0.999658      3498398      2925.71                                           
 8.575     0.999707      3498569      3413.33                                           
 9.239     0.999756      3498740      4096.00                                           
 9.575     0.999780      3498826      4551.11                                           
10.039     0.999805      3498911      5120.00                                           
10.535     0.999829      3498997      5851.43                                           
11.159     0.999854      3499082      6826.67                                           
11.751     0.999878      3499169      8192.00                                           
12.167     0.999890      3499210      9102.22                                           
12.607     0.999902      3499253     10240.00                                           
13.055     0.999915      3499295     11702.86                                           
13.599     0.999927      3499339     13653.33                                           
14.143     0.999939      3499382     16384.00                                           
14.439     0.999945      3499402     18204.44                                           
14.679     0.999951      3499424     20480.00                                           
15.031     0.999957      3499446     23405.71                                           
15.375     0.999963      3499466     27306.67                                           
15.783     0.999969      3499488     32768.00                                           
15.943     0.999973      3499500     36408.89                                           
16.079     0.999976      3499509     40960.00                                           
16.431     0.999979      3499520     46811.43                                           
16.671     0.999982      3499530     54613.33                                           
17.039     0.999985      3499541     65536.00                                           
17.167     0.999986      3499546     72817.78                                           
17.311     0.999988      3499552     81920.00                                           
17.567     0.999989      3499558     93622.86                                           
17.727     0.999991      3499562    109226.67                                           
17.983     0.999992      3499568    131072.00                                           
18.127     0.999993      3499570    145635.56                                           
18.383     0.999994      3499573    163840.00                                           
18.543     0.999995      3499576    187245.71                                           
18.655     0.999995      3499578    218453.33                                           
18.879     0.999996      3499581    262144.00                                           
18.927     0.999997      3499582    291271.11                                           
19.023     0.999997      3499584    327680.00                                           
19.103     0.999997      3499585    374491.43                                           
19.167     0.999998      3499586    436906.67                                           
19.375     0.999998      3499588    524288.00                                           
19.375     0.999998      3499588    582542.22                                           
19.439     0.999998      3499589    655360.00                                           
19.647     0.999999      3499590    748982.86                                           
19.647     0.999999      3499590    873813.33                                           
19.935     0.999999      3499591   1048576.00                                           
19.935     0.999999      3499591   1165084.44                                           
19.967     0.999999      3499592   1310720.00                                           
19.967     0.999999      3499592   1497965.71                                           
19.967     0.999999      3499592   1747626.67                                           
20.015     1.000000      3499593   2097152.00                                           
20.015     1.000000      3499593   2330168.89                                           
20.015     1.000000      3499593   2621440.00                                           
20.015     1.000000      3499593   2995931.43                                           
20.015     1.000000      3499593   3495253.33                                           
21.279     1.000000      3499594   4194304.00                                           
21.279     1.000000      3499594          inf                                           
#[Mean    =   1.101, StdDeviation  =    0.546]                                          
#[Max     =  21.264, Total count   =  3499594]                                          
#[Buckets =      27, SubBuckets    =     2048]                                           
-----------------------------------------------                                          
3599712 requests in 6.00m, 230.01MB read                                                 
Requests/sec:   9999.91                                                                                                 
Transfer/sec:    654.29KB
```

### GET

```text
    Latency     1.23ms  804.79us  45.79ms   87.06%
    Req/Sec     2.64k   223.64     9.44k    71.07%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.15ms
 75.000%    1.58ms
 90.000%    1.95ms
 99.000%    2.63ms
 99.900%    9.57ms
 99.990%   26.83ms
 99.999%   43.58ms
100.000%   45.82ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.090     0.000000            1         1.00
       0.531     0.100000       350929         1.11
       0.706     0.200000       700595         1.25
       0.856     0.300000      1050717         1.43
       1.001     0.400000      1400706         1.67
       1.152     0.500000      1750441         2.00
       1.231     0.550000      1926000         2.22
       1.313     0.600000      2101190         2.50
       1.398     0.650000      2275561         2.86
       1.488     0.700000      2450502         3.33
       1.583     0.750000      2625928         4.00
       1.633     0.775000      2712727         4.44
       1.686     0.800000      2800528         5.00
       1.742     0.825000      2887346         5.71
       1.804     0.850000      2975794         6.67
       1.871     0.875000      3062444         8.00
       1.909     0.887500      3106883         8.89
       1.949     0.900000      3150092        10.00
       1.994     0.912500      3194313        11.43
       2.043     0.925000      3237709        13.33
       2.099     0.937500      3281325        16.00
       2.131     0.943750      3303663        17.78
       2.165     0.950000      3324934        20.00
       2.205     0.956250      3347594        22.86
       2.247     0.962500      3368530        26.67
       2.299     0.968750      3390904        32.00
       2.327     0.971875      3401429        35.56
       2.361     0.975000      3412824        40.00
       2.397     0.978125      3423497        45.71
       2.439     0.981250      3434210        53.33
       2.491     0.984375      3445125        64.00
       2.523     0.985938      3450722        71.11
       2.559     0.987500      3456211        80.00
       2.601     0.989062      3461645        91.43
       2.653     0.990625      3467039       106.67
       2.723     0.992188      3472489       128.00
       2.769     0.992969      3475222       142.22
       2.827     0.993750      3477858       160.00
       2.911     0.994531      3480596       182.86
       3.049     0.995313      3483344       213.33
       3.321     0.996094      3486074       256.00
       3.547     0.996484      3487427       284.44
       3.865     0.996875      3488795       320.00
       4.291     0.997266      3490165       365.71
       4.943     0.997656      3491533       426.67
       5.783     0.998047      3492900       512.00
       6.303     0.998242      3493579       568.89
       6.939     0.998437      3494264       640.00
       7.683     0.998633      3494950       731.43
       8.567     0.998828      3495635       853.33
       9.727     0.999023      3496315      1024.00
      10.439     0.999121      3496657      1137.78
      11.343     0.999219      3496998      1280.00
      12.351     0.999316      3497338      1462.86
      13.527     0.999414      3497681      1706.67
      14.951     0.999512      3498024      2048.00
      15.703     0.999561      3498193      2275.56
      16.591     0.999609      3498366      2560.00
      17.439     0.999658      3498537      2925.71
      18.543     0.999707      3498705      3413.33
      20.351     0.999756      3498877      4096.00
      21.231     0.999780      3498962      4551.11
      22.223     0.999805      3499047      5120.00
      23.231     0.999829      3499132      5851.43
      24.175     0.999854      3499218      6826.67
      25.615     0.999878      3499304      8192.00
      26.351     0.999890      3499346      9102.22
      26.991     0.999902      3499390     10240.00
      28.143     0.999915      3499432     11702.86
      29.391     0.999927      3499474     13653.33
      31.167     0.999939      3499517     16384.00
      32.079     0.999945      3499538     18204.44
      32.991     0.999951      3499560     20480.00
      34.143     0.999957      3499581     23405.71
      35.487     0.999963      3499602     27306.67
      37.407     0.999969      3499624     32768.00
      38.143     0.999973      3499634     36408.89
      39.263     0.999976      3499645     40960.00
      39.999     0.999979      3499656     46811.43
      40.895     0.999982      3499666     54613.33
      42.431     0.999985      3499677     65536.00
      42.751     0.999986      3499682     72817.78
      43.007     0.999988      3499688     81920.00
      43.327     0.999989      3499693     93622.86
      43.647     0.999991      3499698    109226.67
      44.095     0.999992      3499704    131072.00
      44.159     0.999993      3499706    145635.56
      44.223     0.999994      3499710    163840.00
      44.447     0.999995      3499714    187245.71
      44.447     0.999995      3499714    218453.33
      44.735     0.999996      3499718    262144.00
      44.735     0.999997      3499718    291271.11
      44.895     0.999997      3499720    327680.00
      44.927     0.999997      3499721    374491.43
      44.991     0.999998      3499722    436906.67
      45.023     0.999998      3499724    524288.00
      45.023     0.999998      3499724    582542.22
      45.087     0.999998      3499725    655360.00
      45.119     0.999999      3499726    748982.86
      45.119     0.999999      3499726    873813.33
      45.183     0.999999      3499727   1048576.00
      45.183     0.999999      3499727   1165084.44
      45.439     0.999999      3499728   1310720.00
      45.439     0.999999      3499728   1497965.71
      45.439     0.999999      3499728   1747626.67
      45.631     1.000000      3499729   2097152.00
      45.631     1.000000      3499729   2330168.89
      45.631     1.000000      3499729   2621440.00
      45.631     1.000000      3499729   2995931.43
      45.631     1.000000      3499729   3495253.33
      45.823     1.000000      3499730   4194304.00
      45.823     1.000000      3499730          inf
#[Mean    =        1.229, StdDeviation   =        0.805]
#[Max     =       45.792, Total count    =      3499730]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  3599855 requests in 6.00m, 253.59MB read
Requests/sec:   9999.88
Transfer/sec:    721.33KB


```

## Профилировщик

|     | CPU | Alloc | Lock |
| --- | --- | ----- | ---- |
| GET | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/getCpuConcurrentFlush.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/getAllocConcurrentFlush.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/getLockConcurrentFlush.html) |   
| PUT | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/putCpuConcurrentFlush.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/putAllocConcurrentFlush.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/IgorSamohin/2021-highload-dht/blob/igor-samokhin-content/graphs/stage2/putLockConcurrentFlush.html) |

## Выводы

* Вынести flush целиком в отдельный поток с полным отсутствием блокировок не удалось. Все реализации сводились к тому, что под большой нагрузкой в памяти оказывалось слишком много таблиц, готовящихся к flush. Количество таблиц можно уменьшить с помощью увеличения memoryConsumption. Увеличение кучи так же даст некоторый эффект, но по итогу всё все равно упрется в то, что не хватает памяти в куче. Ни смотря на это, даже один параллельный flush в конкретный момент значительно уменьшил максимальную задержку
* По get запросам можно заметить, что LsmDAO.sstableRanges выделяет очень много памяти. Это происходит из-за того, что в памяти скапливается большое количество файлов, которые необходимо проанализировать. Вероятно, создание фонового compaction решило бы проблему.
* Также можно заметить, что выполнение SSTable.offset имеет "полочку". Причем довольно большую. Возможно, стоит сменить алгоритм или как-то его модифицировать. Например, добавить проверку, что первый ключ в файле меньше искомого, а последний - больше. Это возможно снизило бы вычислительную нагрузку, но некоторые случаи работы приводили бы к большому количеству лишних аллокаций